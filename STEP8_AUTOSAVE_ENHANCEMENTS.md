# 🧠 Step 8: 自動保存機能の高度化とUI統合 設計メモ

## 🎯 目的
- 保存失敗時の再試行と利用者への明確な通知
- オフライン時の挙動を安定させ、復帰後に自動保存を再開
- UI上で保存状態・エラー対処方法をわかりやすく表示

## 🚀 対応項目
1. **`useAutoSave` フックの拡張**
   - `status` フラグ（`idle`/`saving`/`saved`/`error`/`retrying`）を追加
   - リトライ回数・最大試行回数・次回再試行時間を管理
   - オフライン検知（`navigator.onLine`）とオンライン復帰時の自動再試行
   - 手動再試行関数 `retry()` を公開

2. **`AutoSaveIndicator` コンポーネント更新**
   - ステータスに応じたアイコン/メッセージを刷新
   - リトライ中の表示、失敗時のエラー内容＋再試行ボタン
   - オフライン時は専用の警告色と文言

3. **執筆画面との統合 (`app/writing/page.tsx`)**
   - フックから返却される `retry` を手動保存ボタンと連携
   - 保存失敗時に軽微なトースト/メッセージ表示（既存UIを活用）
   - セクション切り替え時にリトライ待機をリセット

4. **ドキュメント/テスト**
   - Markdownレポート（本ファイル）に対応状況を追記
   - 保存フローの手動テスト手順を `AUTOSAVE_FIX_REPORT.md` に追加
   - 回帰テスト：新規作成→編集→自動保存→オフライン→再試行

## ✅ 完了条件
- 自動保存成功時に「保存済み」が表示される
- ネットワーク復帰後、自動で保存が再開される
- 保存失敗時、UIにリトライ方法が表示され、手動でも再保存できる
- Consoleに不要なエラーが出ていない

## 📋 作業順序
1. `useAutoSave` のリファクタリング＆型更新
2. `AutoSaveIndicator` のUI刷新
3. 執筆画面のハンドラー更新
4. テスト（オンライン/オフライン、リトライ）
5. ドキュメント更新

## ✅ 実装結果
- `useAutoSave` がリトライ・オフライン復帰に対応し、`status` や `retryCount` を提供
- `AutoSaveIndicator` で保存状態を視覚化し、再試行ボタンとカウントダウンを表示
- 執筆画面が新しい状態を反映し、手動保存ボタンとリトライを統合
- `AUTOSAVE_FIX_REPORT.md` にテスト手順を追記
